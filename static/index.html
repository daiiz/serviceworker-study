<!doctype html>
<html>
  <head>
    <title>sw</title>
    <meta charset='utf-8' />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js'></script>
    <script src='/static/index.js'></script>
  </head>
  <body>
    <p>ServiceWorker</p>
    <div>
      <button id='postMessageToSW'>postMessage to SW</button>
    </div>
    <div>
      <input id='tweet-text' type='text' value='' placeholder='hello!' />
      <button id='tweet'>tweet</button>
    </div>
    <script>
      const postMessageToSWButton = document.querySelector('#postMessageToSW')
      postMessageToSWButton.addEventListener('click', async e => {
        const data = await postMessage({
          title: 'test',
          body: 'Hello, I am your client!'
        })
        console.log('received', data)
      })
    </script>
    <script>
      const tweetButton = document.querySelector('#tweet')
      const tweetText = document.querySelector('#tweet-text')
      const apiClient = axios.create({
        timeout: 10 * 1000
      })

      const addToCache = async req => {
        const cache = await caches.open('tweet')
        const body = await req.json()
        const request = new Request(req.url, {
          method: 'GET',
          body
        })
        return cache.put(request, new Response())
      }

      tweetButton.addEventListener('click', async e => {
        const req = new Request(`/api/tweet?${new Date().getTime()}`, {
          method: 'POST',
          body: JSON.stringify({
            text: tweetText.value || tweetText.placeholder
          }),
          headers: {'Content-Type': 'application/json'}
        })
        try {
          await fetch(req.clone())
          console.log('#', req)
        } catch (err) {
          await addToCache(req)
        }
      })
    </script>
  </body>
</html>
